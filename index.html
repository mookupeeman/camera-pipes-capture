<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Camera Capture</title>
</head>
<body>

    <h1>Camera Capture with Cropping</h1>
    <button id="authorizeButton">Authorize Google Drive</button>
    <video id="video" autoplay style="display: block; margin-bottom: 10px;"></video>
    <canvas id="canvas" style="display: block; margin-bottom: 10px;"></canvas>
    <button id="captureButton">Capture Image</button>
    <canvas id="capturedCanvas" style="display: block; margin-top: 10px;"></canvas>
    
    <script src="https://apis.google.com/js/api.js"></script>
    <script>
        const CLIENT_ID = '594274957992-ev098ch3cl1m1n7oc15nvmlkkkaj5o8e.apps.googleusercontent.com'; // Replace with your client ID
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';

        // Get the elements
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const context = canvas.getContext('2d');
        const captureButton = document.getElementById('captureButton');
        const authorizeButton = document.getElementById('authorizeButton');
        const capturedCanvas = document.getElementById('capturedCanvas');
        const capturedContext = capturedCanvas.getContext('2d');

        let gapiInited = false;
        let tokenClient;

        // Load the auth client and API client library
        function loadClient() {
            gapi.load('client:auth2', initializeGapiClient);
        }

        function initializeGapiClient() {
            gapi.client.init({
                clientId: CLIENT_ID,
                scope: SCOPES,
            }).then(() => {
                gapiInited = true;
            });
        }

        // Handle authorization
        function handleAuthClick() {
            gapi.auth2.getAuthInstance().signIn().then(() => {
                authorizeButton.style.display = 'none';
            });
        }

        authorizeButton.onclick = handleAuthClick;
        gapi.load('client:auth2', loadClient);

        // Access the user's camera
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                video.srcObject = stream;

                video.addEventListener('loadedmetadata', () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    drawRectangleOnVideo();
                });

            } catch (error) {
                console.error('Error accessing the camera: ', error);
            }
        }

        // Draw the rectangle on the video feed
        function drawRectangleOnVideo() {
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            const width = canvas.width;
            const height = canvas.height;

            const cropWidth = width * 0.8;
            const cropHeight = height * 0.8;

            const startX = (width - cropWidth) / 2;
            const startY = (height - cropHeight) / 2;

            context.strokeStyle = 'red';
            context.lineWidth = 2;
            context.strokeRect(startX, startY, cropWidth, cropHeight);

            requestAnimationFrame(drawRectangleOnVideo);
        }

        // Capture the image and upload to Google Drive
        captureButton.addEventListener('click', () => {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            const width = canvas.width;
            const height = canvas.height;

            const cropWidth = width * 0.8;
            const cropHeight = height * 0.8;

            const startX = (width - cropWidth) / 2;
            const startY = (height - cropHeight) / 2;

            const croppedImageData = context.getImageData(startX, startY, cropWidth, cropHeight);

            capturedCanvas.width = cropWidth;
            capturedCanvas.height = cropHeight;
            capturedContext.putImageData(croppedImageData, 0, 0);

            const croppedImageURL = capturedCanvas.toDataURL('image/png');

            uploadImageToDrive(croppedImageURL);
        });

        // Upload the image to Google Drive
        function uploadImageToDrive(imageDataUrl) {
            const byteString = atob(imageDataUrl.split(',')[1]);
            const mimeString = imageDataUrl.split(',')[0].split(':')[1].split(';')[0];
            const buffer = new ArrayBuffer(byteString.length);
            const uintArray = new Uint8Array(buffer);

            for (let i = 0; i < byteString.length; i++) {
                uintArray[i] = byteString.charCodeAt(i);
            }

            const blob = new Blob([buffer], { type: mimeString });
            const metadata = {
                name: 'captured_image.png',
                mimeType: mimeString,
            };

            const formData = new FormData();
            formData.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
            formData.append('file', blob);

            fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                method: 'POST',
                headers: new Headers({ Authorization: 'Bearer ' + gapi.auth.getToken().access_token }),
                body: formData,
            }).then(response => response.json())
              .then(result => {
                  console.log('Uploaded to Google Drive: ', result);
              }).catch(error => {
                  console.error('Error uploading to Google Drive: ', error);
              });
        }

        // Start the camera on page load
        startCamera();
    </script>

</body>
</html>
